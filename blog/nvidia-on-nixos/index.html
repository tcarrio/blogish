<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title></title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.carrio.dev/atom.xml">
      

      
          <link rel="stylesheet" href="https://blog.carrio.dev/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev">
                                <span itemprop="name">Home</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/blog">
                                <span itemprop="name">Blog</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/tags">
                                <span itemprop="name">Tags</span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">Nvidia on NixOS</h1>
        <span class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>5 minute read</span>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2023-11-15
</span>
    </header>
    <div itemprop="articleBody">
        <hr/>
        

<div class="toc">
Table of Contents:
    <ul>
    
        <li>
            <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/#nvidia-on-nixos">Nvidia on NixOS</a>
            
                <ul>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/#the-highs">The Highs</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/#the-lows">The Lows</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/#the-history">The History</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/#software-rendering-not-how-i-would-have-done-it">Software-rendering: Not HOW I would have done it</a>
                        </li>
                    
                </ul>
            
        </li>
    
    </ul>
</div>


        <hr />
        <h1 id="nvidia-on-nixos">Nvidia on NixOS</h1>
<p>NixOS is a really awesome Linux distribution. The declarative, functional approach of defining a configuration that applies consistently to your system is an amazing feat. I have worked with principles akin to this in my professional work for years now, applying infrastructure-as-code methodologies with Terraform &amp; HCL, Pulumi, and Ansible. So, I have not only installed NixOS on my development workstations and home servers, but also on my personal desktop. This device has an Nvidia GTX 1080Ti, and this blog encompasses some of the journey- the highs and the lows- of setting this system up.</p>
<blockquote>
<p>⚠️ This blog post will continue to evolve, as I document more shortcomings and friction in the NixOS journey with Nvidia.</p>
</blockquote>
<h2 id="the-highs">The Highs</h2>
<p>Declarative configuration is often much more concise and hands-off than the more imperative tools. Offerings like Ansible get you much closer to this, but not all the way. NixOS is truly <strong>holistic</strong> in its approach- with everything being possible to manage with Nix expressions, with the help of <a href="https://nix-community.github.io/home-manager">home-manager</a> particularly. These can be broken out and shared between systems. Custom packages can be defined in one place and reused across all of your NixOS systems. You can reference my <a href="https://github.com/tcarrio/nix-config">nix-config</a></p>
<h2 id="the-lows">The Lows</h2>
<p>Declarative has its downsides. The interface provided by the system for <strong>what you want</strong> is extremely important as to allow the implicit <strong>how we do it</strong> to be configurable. Suppose you have a system with an Nvidia graphics card- with NixOS, you can enable most of the behavior you'd like to have with this fairly easily. You include several lines such as which driver you want to use (proprietary vs open-source vs nouveau) as on example. The Nix expression is executed and determines the resulting system configuration.</p>
<p>This is the catch- suppose that how the system is configured does not align with your desires, then you better hope that overriding this is easy or even possible based on what NixOS offers.</p>
<p>In the case of this Nvidia example- many things <em>just work</em>, but there are a couple cases that <em>do not</em>, and these are the pain points that leave you stuck for weeks without a 100% functional system.</p>
<h2 id="the-history">The History</h2>
<p>I switched from an Arch Linux system to NixOS in the desire to more easily maintain my workstation in entirety. My Arch system was over 6 years old and had reached over 1000 packages installed. What were half of these? What had I done to configure them? What configurations could be cleaned up? The evidence is scattered across the filesystem, only clear to those most familiar with the configuration rules of each particular software I had. This was a situation I wanted to escape- so I could better understand everything I had and also to be better able to maintain that system over the long-term.</p>
<p>Documentation separate from code tends to decay. Once it's committed, the drift begins. Code <strong>as</strong> documentation breaks from this problem at its core- you don't need to have entirely separate docs from your code- often times having a service enabled or configured in some way is <strong>clear as day</strong>.</p>
<pre data-lang="nix" style="background-color:#171c19;color:#87928a;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>    </span><span style="color:#9f713c;">services</span><span>.</span><span style="color:#9f713c;">deathStar </span><span>= {
</span><span>        </span><span style="color:#9f713c;">enabled </span><span>= </span><span style="color:#9f713c;">true</span><span>;
</span><span>        </span><span style="color:#9f713c;">customConfig </span><span>= &#39;&#39;
</span><span style="color:#489963;">            something something dark side
</span><span style="color:#489963;">        </span><span>&#39;&#39;;
</span><span>    };
</span><span>}
</span></code></pre>
<p>Even enabling Nvidia hardware is remarkably simple!</p>
<pre data-lang="nix" style="background-color:#171c19;color:#87928a;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>    </span><span style="color:#9f713c;">hardware</span><span>.</span><span style="color:#9f713c;">nvidia </span><span>= </span><span style="color:#55859b;">with </span><span style="color:#b16139;">config</span><span>.</span><span style="color:#b16139;">boot</span><span>.</span><span style="color:#b16139;">kernelPackages</span><span>.</span><span style="color:#b16139;">nvidiaPackages</span><span>; {
</span><span>        </span><span style="color:#9f713c;">package </span><span>= </span><span style="color:#b16139;">stable</span><span>;
</span><span>    };
</span><span>}
</span></code></pre>
<p>The NixOS docs provide a list of which packages are available plainly <a href="https://blog.carrio.dev/blog/nvidia-on-nixos/nvidia-driver-versions">here</a>. You can now readily switch out various Nvidia driver versions with just a few characters. Want to run the latest beta version?</p>
<pre data-lang="nix" style="background-color:#171c19;color:#87928a;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>    </span><span style="color:#9f713c;">hardware</span><span>.</span><span style="color:#9f713c;">nvidia </span><span>= </span><span style="color:#55859b;">with </span><span style="color:#b16139;">config</span><span>.</span><span style="color:#b16139;">boot</span><span>.</span><span style="color:#b16139;">kernelPackages</span><span>.</span><span style="color:#b16139;">nvidiaPackages</span><span>; {
</span><span>        </span><span style="color:#9f713c;">package </span><span>= </span><span style="color:#b16139;">beta</span><span>;
</span><span>    };
</span><span>}
</span></code></pre>
<h2 id="software-rendering-not-how-i-would-have-done-it">Software-rendering: Not HOW I would have done it</h2>
<p>This is the moment that <strong>declarative</strong> configuration became a pain. As I mentioned before, I replaced my Arch Linux system. I had a few games installed: Overwatch on Lutris and Elder Scrolls IV: Oblivion. These were the only two I played much of.</p>
<p>I installed Steam through my Nix config. Super easy.</p>
<p>I installed Elder Scrolls IV: Oblivion. Turned on the compatibility mode for Proton. Super easy.</p>
<p>Started up the game: 0.00000001 FPS.</p>
<p>It would appear I'm using software rendering. But why? Why in the world would my system even want to use software rendering when it has a <strong>perfectly powerful discrete graphics card</strong>?</p>
<p>Well, let's see what's available.</p>
<pre data-lang="sh" style="background-color:#171c19;color:#87928a;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#b16139;">vulkaninfo --summary
</span></code></pre>
<p>This pops out a massive list of info, but the final section I'm including here is the most important piece:</p>
<pre style="background-color:#171c19;color:#87928a;"><code><span>Devices:
</span><span>========
</span><span>GPU0:
</span><span>	apiVersion         = 1.3.260
</span><span>	driverVersion      = 545.29.2.0
</span><span>	vendorID           = 0x10de
</span><span>	deviceID           = 0x1b06
</span><span>	deviceType         = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
</span><span>	deviceName         = NVIDIA GeForce GTX 1080 Ti
</span><span>	driverID           = DRIVER_ID_NVIDIA_PROPRIETARY
</span><span>	driverName         = NVIDIA
</span><span>	driverInfo         = 545.29.02
</span><span>	conformanceVersion = 1.3.6.0
</span><span>	deviceUUID         = 61ede7bb-89b8-5ef5-50a7-899e37452c5d
</span><span>	driverUUID         = aa471f58-d70e-5a93-a86b-06356da49d1c
</span><span>GPU1:
</span><span>	apiVersion         = 1.3.246
</span><span>	driverVersion      = 0.0.1
</span><span>	vendorID           = 0x10005
</span><span>	deviceID           = 0x0000
</span><span>	deviceType         = PHYSICAL_DEVICE_TYPE_CPU
</span><span>	deviceName         = llvmpipe (LLVM 16.0.6, 256 bits)
</span><span>	driverID           = DRIVER_ID_MESA_LLVMPIPE
</span><span>	driverName         = llvmpipe
</span><span>	driverInfo         = Mesa 23.1.9 (LLVM 16.0.6)
</span><span>	conformanceVersion = 1.3.1.1
</span><span>	deviceUUID         = 6d657361-3233-2e31-2e39-000000000000
</span><span>	driverUUID         = 6c6c766d-7069-7065-5555-494400000000
</span></code></pre>
<p>It would appear that a <code>llvmpipe</code> device is automatically configured here. But why? I didn't turn on Mesa myself, what is a Mesa driver doing here?</p>
<p>Well- there are plenty of packages that may rely on Mesa. In fact, a large number of them will. So this is going to be a dependency in the system and automatically be installed.</p>
<h3 id="solution">Solution?</h3>
<p>Honestly, I've tried a number of things so far: from overlays and explicit configurations to not include mesa in the stack when configuring opengl.</p>
<p>I'll update the post with a <strong>Solved:</strong> tag once I make it there. For now, I suffer. 😭</p>
<!-- Reference -->

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Tom Carrio
                
                
                
                    
                    tagged
                    
                        <a href="https://blog.carrio.dev/tags/nix/">nix</a>
                        
                            
                                
                                    and
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/graphics/">graphics</a>
                        
                            
                        
                    
                
            </p>
            
            
        </footer>
    
</article>


    </body>

</html>
