<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title></title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.carrio.dev/atom.xml">
      

      
          <link rel="stylesheet" href="https://blog.carrio.dev/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev">
                                <span itemprop="name">Home</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/blog">
                                <span itemprop="name">Blog</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/tags">
                                <span itemprop="name">Tags</span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">direnv magic: instant project environments</h1>
        <span class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>4 minute read</span>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2023-09-21
</span>
    </header>
    <div itemprop="articleBody">
        <hr/>
        

<div class="toc">
Table of Contents:
    <ul>
    
        <li>
            <a href="https://blog.carrio.dev/blog/direnv-magic/#direnv-magic">direnv magic</a>
            
                <ul>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/direnv-magic/#an-alternative-approach">an alternative approach</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/direnv-magic/#the-behavior">the behavior</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/direnv-magic/#automated-secure-shell-environments">automated, secure shell environments</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/direnv-magic/#an-example-with-nix-flakes">an example with Nix flakes</a>
                        </li>
                    
                        <li>
                            <a href="https://blog.carrio.dev/blog/direnv-magic/#graceful-departures">graceful departures</a>
                        </li>
                    
                </ul>
            
        </li>
    
    </ul>
</div>


        <hr />
        <h1 id="direnv-magic">direnv magic</h1>
<p>A very popular project for managing environment variables in projects today is <code>dotenv</code>. There are packages for various languages, like NodeJS and PHP. They are built on a simple principle: to load environment variables from a <code>.env</code> file located in the project root.</p>
<p>When it comes to the 12 Factor App, managing environment variables in source control is generally discouraged. Instead, environment variables should be set externally, like via the OS or a container orchestrator. However, <code>dotenv</code> packages rely on the application loading the <code>.env</code> file itself, which means that the application must process a file in order to retrieve its environment configuration.</p>
<p>As a whole, this practice is convenient for local development, but does not lend well to the Config principle of the 12 Factor App.</p>
<h2 id="an-alternative-approach">an alternative approach</h2>
<p>The <code>direnv</code> tool allows environment variables to be set based on the directory. With <code>direnv</code>, you can define environment variables in a <code>.envrc</code> file that will be loaded automatically when entering that directory. This avoids embedding environment configuration in the application code/source control, and makes variables configurable on a per-directory basis. It also entirely avoids having dependencies on files and the entirety of the <code>dotenv</code> package itself in a production application. You don't have to conditionally load files - the environment is configured automatically by the shell in local development environments, and configured by the orchestrator in production, like Kubernetes, in the exact same manner: <strong>the environment variables</strong>.</p>
<h2 id="the-behavior">the behavior</h2>
<p>Working with <code>direnv</code>, you gain the ability to not only define environment variables in a <code>.envrc</code> file per directory, but also automatically configure your shell environment based on that file in other means. For example, you can automatically execute scripts or enter a Nix flake dev shell.</p>
<h2 id="automated-secure-shell-environments">automated, secure shell environments</h2>
<p>Due to the simple approach of a <code>.envrc</code> file and automatic nature of <code>direnv</code>, it provides a streamlined solution for automatically entering development environments in a snap. It also requires that you permit a directory before <code>direnv</code> will load variables or execute scripts, preventing accidental exposure in untrusted directories.</p>
<h2 id="an-example-with-nix-flakes">an example with Nix flakes</h2>
<p>Suppose we have a Nix flake in our project repository that defines a development shell environment. With <code>direnv</code>, we can automatically enter this shell whenever we cd into the project directory. We'll start with this project's Nix flake, which provides a shell with the necessary tools to build and develop the blog.</p>
<pre data-lang="nix" style="background-color:#171c19;color:#87928a;" class="language-nix "><code class="language-nix" data-lang="nix"><span>{
</span><span>  </span><span style="color:#9f713c;">description </span><span>= &quot;</span><span style="color:#489963;">0xc dev shell</span><span>&quot;;
</span><span>
</span><span>  </span><span style="color:#9f713c;">inputs</span><span>.</span><span style="color:#9f713c;">nixpkgs</span><span>.</span><span style="color:#9f713c;">url </span><span>= &quot;</span><span style="color:#489963;">github:NixOS/nixpkgs/nixpkgs-unstable</span><span>&quot;;
</span><span>
</span><span>  </span><span style="color:#9f713c;">outputs </span><span>= </span><span style="color:#478c90;">{ </span><span>pkgs </span><span style="color:#478c90;">}</span><span>: {
</span><span>    </span><span style="color:#9f713c;">devShells</span><span>.&quot;</span><span style="color:#489963;">x86_64-linux</span><span>&quot;.</span><span style="color:#9f713c;">default </span><span>= </span><span style="color:#b16139;">pkgs</span><span>.</span><span style="color:#b16139;">mkShell </span><span>{
</span><span>      </span><span style="color:#9f713c;">packages </span><span>= </span><span style="color:#55859b;">with </span><span style="color:#b16139;">pkgs</span><span>; [
</span><span>        </span><span style="color:#b16139;">git
</span><span>        </span><span style="color:#b16139;">zola
</span><span>      ];
</span><span>
</span><span>      </span><span style="color:#9f713c;">PROJECT_NAME </span><span>= &quot;</span><span style="color:#489963;">0xc</span><span>&quot;;
</span><span>
</span><span>      </span><span style="color:#9f713c;">shellHook </span><span>= &#39;&#39;
</span><span style="color:#489963;">        echo $ Started devshell for $PROJECT_NAME
</span><span style="color:#489963;">        echo
</span><span style="color:#489963;">        uname -v
</span><span style="color:#489963;">        echo
</span><span style="color:#489963;">        git --version
</span><span style="color:#489963;">        echo
</span><span style="color:#489963;">        echo &quot;zola version $(zola --version)&quot;
</span><span style="color:#489963;">        echo
</span><span style="color:#489963;">      </span><span>&#39;&#39;;
</span><span>    };
</span><span>  };
</span><span>}
</span></code></pre>
<p>That ensures that I can access both <code>git</code> and <code>zola</code> in my dev shell.</p>
<p>The <code>direnv</code> tool has native support for Nix flakes, so enabling this is a single line in our <code>.envrc</code>:</p>
<pre style="background-color:#171c19;color:#87928a;"><code><span>use flake
</span></code></pre>
<p>That's it! Now in the project, you'll have to permit <code>direnv</code> once:</p>
<pre data-lang="bash" style="background-color:#171c19;color:#87928a;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#b16139;">direnv</span><span> allow
</span></code></pre>
<p>Now you are ready to automatically enter your desired shell environment.</p>
<h2 id="graceful-departures">graceful departures</h2>
<p>Not only does <code>direnv</code> work well when navigating around projects, it also handles exiting an environment smoothly. Dependencies you may not have had that the Nix flake included in the dev shell, such as <code>zola</code>, will no longer be available after leaving the project directory.</p>
<pre style="background-color:#171c19;color:#87928a;"><code><span>[ ~/Code/blog ]: which zola
</span><span>/nix/store/qsaq50z4hln6f86ymvp5f5j01wqg21c3-zola-0.17.2/bin/zola
</span><span>
</span><span>[ ~/Code/blog ]: cd ..
</span><span>direnv: unloading
</span><span>
</span><span>[ ~/Code ]: which zola
</span><span>which: no zola in (/nix/store/16d7k6ljgy635fz5jn1flnvpx1gnx9cp-glib-2.76.4-bin/bin:/run/wrappers/bin:/home/tcarrio/.local/share/flatpak/exports/bin:/var/lib/flatpak/exports/bin:/home/tcarrio/.nix-profile/bin:/etc/profiles/per-user/tcarrio/bin:/nix/var/nix/profiles/default/bin:/run/current-system/sw/bin:/home/tcarrio/.local/bin)
</span></code></pre>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Tom Carrio
                
                
                
                    
                    tagged
                    
                        <a href="https://blog.carrio.dev/tags/nix/">nix</a>
                        
                            
                                
                                    ,
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/dev/">dev</a>
                        
                            
                                
                                    ,
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/swe/">swe</a>
                        
                            
                                
                                    and
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/12-factor-app/">12-factor-app</a>
                        
                            
                        
                    
                
            </p>
            
            
        </footer>
    
</article>


    </body>

</html>
