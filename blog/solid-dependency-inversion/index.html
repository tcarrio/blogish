<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title></title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.carrio.dev/atom.xml">
      

      
          <link rel="stylesheet" href="https://blog.carrio.dev/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev">
                                <span itemprop="name">Home</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/blog">
                                <span itemprop="name">Blog</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https://blog.carrio.dev/tags">
                                <span itemprop="name">Tags</span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">SOLID Principles: Dependency Inversion</h1>
        <span class="muted">
    <svg class="icon i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>7 minute read</span>
    <svg class="icon i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2023-07-29
</span>
    </header>
    <div itemprop="articleBody">
        <hr/>
        

<div class="toc">
Table of Contents:
    <ul>
    
        <li>
            <a href="https://blog.carrio.dev/blog/solid-dependency-inversion/#what-is-dependency-inversion">What is Dependency Inversion</a>
            
        </li>
    
        <li>
            <a href="https://blog.carrio.dev/blog/solid-dependency-inversion/#example">Example</a>
            
        </li>
    
    </ul>
</div>


        <hr />
        <p>SOLID constitutes five design principles focused on making object-oriented designs more maintainable, understable, and flexible. The principles of SOLID are:</p>
<p><strong>S</strong>ingle-responsibility principle</p>
<p><strong>O</strong>pen-closed principle</p>
<p><strong>L</strong>iskov substitution principle</p>
<p><strong>I</strong>nterface segregation principle</p>
<p><strong>D</strong>ependency inversion principle</p>
<p>In this post, I'm going to cover the final principle, <strong>Dependency Inversion</strong>.</p>
<h2 id="what-is-dependency-inversion">What is Dependency Inversion</h2>
<p>In a few words, the Dependency Inversion principle (DIP) can be described as:</p>
<blockquote>
<p>Depend on abstractions, not concretions</p>
</blockquote>
<p>In many object-oriented languages, abstractions would often refer to an Interface and concretions on a Class implementation of it. There are several benefits that come from this:</p>
<p><em>Decoupling of components</em>: DIP encourages the decoupling of high-level modules from low-level modules. By introducing abstractions and interfaces, it allows components to interact with each other without needing to know specific implementation details. This reduces the tight coupling between modules, making the code more flexible and easier to maintain.</p>
<p><em>Reusability</em>: With DIP, components depend on abstractions rather than concrete implementations. This promotes reusability as multiple implementations can be created for the same interface, allowing different components to use them interchangeably.</p>
<p><em>Testability</em>: By programming to interfaces rather than concrete classes, unit testing becomes easier. Mocking or stubbing interfaces during testing becomes straightforward, enabling more effective and isolated testing of individual components.</p>
<p><em>Encourages a stable architecture</em>: Following DIP leads to a more stable architecture as changes to low-level modules or concrete implementations are less likely to affect higher-level modules. This principle facilitates the &quot;Open/Closed Principle&quot; (OCP) by allowing the system to be easily extended with new functionalities without modifying existing code.</p>
<p><em>Inversion of control (IoC)</em>: DIP is often associated with IoC containers that manage the creation and resolution of dependencies. By using an IoC container, the responsibility for managing object instantiation and dependency resolution is shifted from the application code to the container, simplifying the overall design and promoting a more modular and maintainable structure.</p>
<p>While there are many benefits to following DIP, I would still warn that there are definitely some downfalls to <em>over-applying</em> this pattern. However, it generally leaves your project in a significantly better state for future changes and growth.</p>
<h2 id="example">Example</h2>
<p>This example dives into an application of the dependency inversion principle, but it inadvertently will also showcase a couple of other patterns closely related to this, including the general pattern of Inversion of Control and the Dependency Injection pattern, whose functionality is often provided by some application framework like Spring.</p>
<p>Here, we'll have some application which manipulates users in the system. We will have a UserService and a UserRepository, and the UserRepository will be an <strong>interface</strong> as opposed to a specific implementation. The UserRepository is implemented by multiple classes, and in this case we have an implementation backed by MySQL and another by Redis. However, the UserService itself has no knowledge of which implementation it is interacting with, and never should. It only cares about the contract in which it interacts with the instance it has a reference to.</p>
<p>To start off, I'll define a core model I won't include in the graph below but will be necessary regardless. The <code>User</code>!</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">class </span><span style="color:#a07e3b;">User </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">constructor</span><span>(
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">public readonly </span><span style="color:#b16139;">id</span><span>: </span><span style="color:#ecf4ee;">string,
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">public readonly </span><span style="color:#b16139;">email</span><span>: </span><span style="color:#ecf4ee;">string,
</span><span style="color:#ecf4ee;">    </span><span>)
</span><span style="color:#ecf4ee;">}
</span></code></pre>
<p>Now, we can define our abstraction around interacting with the Users in the system. In my case, I would be defining the UserRepository as a collection-like interface (no necessary <code>persist()</code> calls on the Repository to push updates to the data store).</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">interface </span><span>UserRepository {
</span><span>    </span><span style="color:#478c90;">nextId</span><span>(): Promise&lt;string&gt;;
</span><span>    </span><span style="color:#478c90;">add</span><span>(</span><span style="color:#b16139;">user</span><span>: User): Promise&lt;void&gt;;
</span><span>    </span><span style="color:#478c90;">delete</span><span>(</span><span style="color:#b16139;">user</span><span>: User): Promise&lt;void&gt;;
</span><span>    </span><span style="color:#478c90;">findByEmail</span><span>(</span><span style="color:#b16139;">id</span><span>: string): Promise&lt;User&gt;;
</span><span>}
</span></code></pre>
<p>Now, I haven't actually implemented this repository yet, but I can already start to envision my domain service, where I'll provide functionality for creating a User with their email.</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">class </span><span style="color:#a07e3b;">UserService </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">constructor</span><span>(</span><span style="color:#55859b;">private readonly </span><span style="color:#b16139;">userRepository</span><span>: </span><span style="color:#ecf4ee;">UserRepository</span><span>) </span><span style="color:#ecf4ee;">{}
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">createNewUser</span><span>(</span><span style="color:#b16139;">email</span><span>: </span><span style="color:#ecf4ee;">string</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">userRepository</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">findByEmail</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">email</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">user </span><span>= new </span><span style="color:#ecf4ee;">User(</span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">userRepository</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">nextId</span><span style="color:#ecf4ee;">(), </span><span style="color:#b16139;">email</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">userRepository</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">add</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">}
</span></code></pre>
<p>Great! We're going to be creating user's with this service, now let's really implement a UserRepository that we can get started with. I'm going to use a simple in-memory backend like Redis here. I might lose everything when I restart Redis but I just want to test the system out locally for now.</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">class </span><span style="color:#a07e3b;">RedisUserRepository </span><span style="color:#55859b;">implements </span><span style="color:#489963;">UserRepository </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private static readonly </span><span style="color:#b16139;">PREFIX </span><span>= &#39;</span><span style="color:#489963;">user</span><span>&#39;</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">constructor</span><span>(</span><span style="color:#55859b;">private readonly </span><span style="color:#b16139;">redis</span><span>: </span><span style="color:#ecf4ee;">Redis</span><span>) </span><span style="color:#ecf4ee;">{}
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">nextId</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;string&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#478c90;">uuid</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">add</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">set</span><span style="color:#ecf4ee;">(
</span><span style="color:#ecf4ee;">            </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">calculateKey</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">),
</span><span style="color:#ecf4ee;">            </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">serializeUser</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">),
</span><span style="color:#ecf4ee;">        );
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">delete</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">del</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">calculateKey</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">));
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">findByEmail</span><span>(</span><span style="color:#b16139;">email</span><span>: </span><span style="color:#ecf4ee;">string</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;User&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">matchingKeys </span><span>= </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">scan</span><span style="color:#ecf4ee;">(</span><span>`</span><span style="color:#489963;">0 MATCH user::*::${</span><span style="color:#b16139;">this</span><span style="color:#489963;">.</span><span style="color:#478c90;">base64Encode</span><span style="color:#489963;">(</span><span style="color:#b16139;">email</span><span style="color:#489963;">)}</span><span>`</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">if </span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">matchingKeys</span><span style="color:#ecf4ee;">.length </span><span>=== </span><span style="color:#9f713c;">0</span><span style="color:#ecf4ee;">) {
</span><span style="color:#ecf4ee;">            </span><span style="color:#55859b;">throw </span><span>new </span><span style="color:#ecf4ee;">NotFoundException();
</span><span style="color:#ecf4ee;">        }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">if </span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">matchingKeys</span><span style="color:#ecf4ee;">.length </span><span>&gt; </span><span style="color:#9f713c;">1</span><span style="color:#ecf4ee;">) {
</span><span style="color:#ecf4ee;">            </span><span style="color:#55859b;">throw </span><span>new </span><span style="color:#ecf4ee;">MultipleUsersForSameEmailException();
</span><span style="color:#ecf4ee;">        }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">user </span><span>= </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">get</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">matchingKeys</span><span style="color:#ecf4ee;">[</span><span style="color:#9f713c;">0</span><span style="color:#ecf4ee;">]);
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">if </span><span style="color:#ecf4ee;">(</span><span>typeof </span><span style="color:#b16139;">user </span><span>=== &#39;</span><span style="color:#489963;">string</span><span>&#39;</span><span style="color:#ecf4ee;">) {
</span><span style="color:#ecf4ee;">            </span><span style="color:#55859b;">return </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">deserializeUser</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">        }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private </span><span style="color:#478c90;">calculateKey</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">string {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#ecf4ee;">{ </span><span style="color:#b16139;">id</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">email </span><span style="color:#ecf4ee;">} </span><span>= </span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span>`</span><span style="color:#489963;">${</span><span style="color:#b16139;">RedisUserRepository</span><span style="color:#489963;">.</span><span style="color:#b16139;">PREFIX</span><span style="color:#489963;">}::${</span><span style="color:#b16139;">this</span><span style="color:#489963;">.</span><span style="color:#478c90;">base64Encode</span><span style="color:#489963;">(</span><span style="color:#b16139;">id</span><span style="color:#489963;">)}::${</span><span style="color:#b16139;">this</span><span style="color:#489963;">.</span><span style="color:#478c90;">base64Encode</span><span style="color:#489963;">(</span><span style="color:#b16139;">email</span><span style="color:#489963;">)}</span><span>`</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private </span><span style="color:#478c90;">base64Encode</span><span>(</span><span style="color:#b16139;">text</span><span>: </span><span style="color:#ecf4ee;">string</span><span>): </span><span style="color:#ecf4ee;">string {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span>new </span><span style="color:#ecf4ee;">Buffer(</span><span style="color:#b16139;">text</span><span style="color:#ecf4ee;">).</span><span style="color:#1c9aa0;">toString</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">base64</span><span>&#39;</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private </span><span style="color:#478c90;">deserializeUser</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">string</span><span>): </span><span style="color:#ecf4ee;">User {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#ecf4ee;">JSON.</span><span style="color:#1c9aa0;">parse</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private </span><span style="color:#478c90;">serializeUser</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">string {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#ecf4ee;">JSON.</span><span style="color:#478c90;">serialize</span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">}
</span></code></pre>
<p>Now we need to actually instantiate all of these things. Here I'll build out my application container that creates instances of these components and wires it all together. Many people prefer to use a Dependency Injection framework to accomplish this, but I'm keeping this post example simple:</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">import </span><span>{ </span><span style="color:#b16139;">createClient </span><span>} </span><span style="color:#55859b;">from </span><span>&#39;</span><span style="color:#489963;">redis</span><span>&#39;;
</span><span>
</span><span style="color:#55859b;">class </span><span style="color:#a07e3b;">ApplicationContainer </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private static </span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">static async </span><span style="color:#478c90;">bootstrap</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">startUp</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">main</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">shutDown</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">static async </span><span style="color:#478c90;">startUp</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis </span><span>= </span><span style="color:#478c90;">createClient</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">        </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">on</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">error</span><span>&#39;</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">err </span><span style="color:#55859b;">=&gt; </span><span style="color:#a07e3b;">console</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">error</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">Redis Client Error</span><span>&#39;</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">err</span><span style="color:#ecf4ee;">));
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">connect</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">static async </span><span style="color:#478c90;">main</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">userRepository </span><span>= new </span><span style="color:#ecf4ee;">RedisUserRepository(</span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">userService </span><span>= new </span><span style="color:#ecf4ee;">UserService(</span><span style="color:#b16139;">userRepository</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">userService</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">createNewUser</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">username@example.com</span><span>&#39;</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">static async </span><span style="color:#478c90;">shutDown</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">redis</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">disconnect</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">}
</span><span>
</span><span>new ApplicationContainer().</span><span style="color:#478c90;">bootstrap</span><span>();
</span></code></pre>
<p>Everything is working great so far. I'd like to build out an implementation now that backs itself on the same data store the rest of our production services run on- MySQL! Let's see what that looks like:</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">class </span><span style="color:#a07e3b;">MySQLUserRepository </span><span style="color:#55859b;">implements </span><span style="color:#489963;">UserRepository </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">constructor</span><span>(</span><span style="color:#55859b;">private readonly </span><span style="color:#b16139;">connection</span><span>: </span><span style="color:#ecf4ee;">MySQL</span><span>) </span><span style="color:#ecf4ee;">{}
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">nextId</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;string&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#478c90;">uuid</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">add</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#ecf4ee;">{ </span><span style="color:#b16139;">id</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">email </span><span style="color:#ecf4ee;">} </span><span>= </span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">connection</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">execute</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">INSERT INTO `Users` VALUES (?, ?);</span><span>&#39;</span><span style="color:#ecf4ee;">, [</span><span style="color:#b16139;">id</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">email</span><span style="color:#ecf4ee;">]);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">delete</span><span>(</span><span style="color:#b16139;">user</span><span>: </span><span style="color:#ecf4ee;">User</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">connection</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">execute</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">DELETE FROM `Users` WHERE `id` = ?;</span><span>&#39;</span><span style="color:#ecf4ee;">, </span><span style="color:#b16139;">user</span><span style="color:#ecf4ee;">.id);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">async </span><span style="color:#478c90;">findByEmail</span><span>(</span><span style="color:#b16139;">email</span><span>: </span><span style="color:#ecf4ee;">string</span><span>): </span><span style="color:#ecf4ee;">Promise&lt;User&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#ecf4ee;">[</span><span style="color:#b16139;">users</span><span style="color:#ecf4ee;">] </span><span>= </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">connection</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">queryRows</span><span style="color:#ecf4ee;">(
</span><span style="color:#ecf4ee;">            </span><span>&#39;</span><span style="color:#489963;">SELECT * FROM `Users` ORDER BY `id` ASC;</span><span>&#39;</span><span style="color:#ecf4ee;">,
</span><span style="color:#ecf4ee;">        );
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">if </span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">users</span><span style="color:#ecf4ee;">.length </span><span>=== </span><span style="color:#9f713c;">0</span><span style="color:#ecf4ee;">) {
</span><span style="color:#ecf4ee;">            </span><span style="color:#55859b;">throw </span><span>new </span><span style="color:#ecf4ee;">NotFoundException();
</span><span style="color:#ecf4ee;">        }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">if </span><span style="color:#ecf4ee;">(</span><span style="color:#b16139;">users</span><span style="color:#ecf4ee;">.length </span><span>&gt; </span><span style="color:#9f713c;">1</span><span style="color:#ecf4ee;">) {
</span><span style="color:#ecf4ee;">            </span><span style="color:#55859b;">throw </span><span>new </span><span style="color:#ecf4ee;">MultipleUsersForSameEmailException();
</span><span style="color:#ecf4ee;">        }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">return </span><span style="color:#b16139;">users</span><span style="color:#ecf4ee;">[</span><span style="color:#9f713c;">0</span><span style="color:#ecf4ee;">];
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">}
</span></code></pre>
<p>Now, we'll update the Application Container to create the MySQLUserRepository instance and pass that in instead. All set to go!</p>
<pre data-lang="ts" style="background-color:#171c19;color:#87928a;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#55859b;">import </span><span style="color:#b16139;">mysql </span><span style="color:#55859b;">from </span><span>&#39;</span><span style="color:#489963;">mysql2/promise</span><span>&#39;;
</span><span>
</span><span>
</span><span style="color:#55859b;">class </span><span style="color:#a07e3b;">ApplicationContainer </span><span style="color:#ecf4ee;">{
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">private static </span><span style="color:#b16139;">mysql</span><span style="color:#ecf4ee;">;
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">static async </span><span style="color:#478c90;">bootstrap</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">startUp</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">main</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">shutDown</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">protected static async </span><span style="color:#478c90;">startUp</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">mysql </span><span>= </span><span style="color:#55859b;">await </span><span style="color:#b16139;">mysql</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">createConnection</span><span style="color:#ecf4ee;">({host:</span><span>&#39;</span><span style="color:#489963;">localhost</span><span>&#39;</span><span style="color:#ecf4ee;">, user: </span><span>&#39;</span><span style="color:#489963;">root</span><span>&#39;</span><span style="color:#ecf4ee;">, database: </span><span>&#39;</span><span style="color:#489963;">test</span><span>&#39;</span><span style="color:#ecf4ee;">});
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">protected static async </span><span style="color:#478c90;">main</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">userRepository </span><span>= new </span><span style="color:#ecf4ee;">MySQLUserRepository(</span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">mysql</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">const </span><span style="color:#b16139;">userService </span><span>= new </span><span style="color:#ecf4ee;">UserService(</span><span style="color:#b16139;">userRepository</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">userService</span><span style="color:#ecf4ee;">.</span><span style="color:#478c90;">createNewUser</span><span style="color:#ecf4ee;">(</span><span>&#39;</span><span style="color:#489963;">username@example.com</span><span>&#39;</span><span style="color:#ecf4ee;">);
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">
</span><span style="color:#ecf4ee;">    </span><span style="color:#55859b;">protected static async </span><span style="color:#478c90;">shutDown</span><span>(): </span><span style="color:#ecf4ee;">Promise&lt;void&gt; {
</span><span style="color:#ecf4ee;">        </span><span style="color:#55859b;">await </span><span style="color:#b16139;">this</span><span style="color:#ecf4ee;">.</span><span style="color:#b16139;">mysql</span><span style="color:#ecf4ee;">.</span><span style="color:#1c9aa0;">close</span><span style="color:#ecf4ee;">();
</span><span style="color:#ecf4ee;">    }
</span><span style="color:#ecf4ee;">}
</span><span>
</span><span>new ApplicationContainer().</span><span style="color:#478c90;">bootstrap</span><span>();
</span></code></pre>
<p>As you can see from this, none of our logic needed to change around the actual business logic layer of our code. This is also why Dependency Inversion is seen as one way to facilitate Inversion of Control, as we are passing dependencies from the top down as opposed to calling or creating external modules within our domain logic.</p>
<p>Here is a graph of how these interfaces, class implementations, and the application container relate to each other:</p>
<pre style="background-color:#171c19;color:#87928a;"><code><span>┌──────────────────────┐
</span><span>│                      │
</span><span>│     Application      │    passes instance to
</span><span>│     Container        ├────────────────────────┐
</span><span>│                      │                        │
</span><span>└──────────────┬───────┘                        │
</span><span>               │                                │
</span><span>               │                                │
</span><span>               │                     ┌──────────▼──────────┐
</span><span>               │                     │      UserService    │
</span><span>               │                     │                     │
</span><span>               │                     └──────────┬──────────┘
</span><span>               │                                │
</span><span>               │                                │
</span><span>               │                                │
</span><span>          instantiates                   interacts with
</span><span>               │                                │
</span><span>               │                                │
</span><span>               │                                │
</span><span>               │                     ┌──────────┴──────────┐
</span><span>               │                     │   UserRepository    │
</span><span>               │                     │                     │
</span><span>               │                     └──────────┬──────────┘
</span><span>               │                                │
</span><span>               │                    ┌───────────┴─────────────┐
</span><span>               │                    │      implements         │
</span><span>               │                    │                         │
</span><span>               │                    │                         │
</span><span>               │         ┌──────────┴──────────┐   ┌──────────┴──────────┐
</span><span>               │         │ MySQLUserRepository │   │ RedisUserRepository │
</span><span>               └─────────►                     │   │                     │
</span><span>                         └─────────────────────┘   └─────────────────────┘
</span></code></pre>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Tom Carrio
                
                
                
                    
                    tagged
                    
                        <a href="https://blog.carrio.dev/tags/swe/">swe</a>
                        
                            
                                
                                    ,
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/patterns/">patterns</a>
                        
                            
                                
                                    and
                                
                            
                        
                    
                        <a href="https://blog.carrio.dev/tags/solid/">solid</a>
                        
                            
                        
                    
                
            </p>
            
            
        </footer>
    
</article>


    </body>

</html>
