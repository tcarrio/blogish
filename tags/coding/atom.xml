<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title> - coding</title>
    <link rel="self" type="application/atom+xml" href="https://blog.carrio.dev/tags/coding/atom.xml"/>
    <link rel="alternate" type="text/html" href="https://blog.carrio.dev"/>
    <generator uri="https://www.getzola.org/">Zola</generator>
    <updated>2023-07-29T00:00:00+00:00</updated>
    <id>https://blog.carrio.dev/tags/coding/atom.xml</id>
    <entry xml:lang="en">
        <title>Domain-Driven Design Patterns: An Introduction</title>
        <published>2023-07-29T00:00:00+00:00</published>
        <updated>2023-07-29T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://blog.carrio.dev/blog/ddd-patterns-intro/"/>
        <id>https://blog.carrio.dev/blog/ddd-patterns-intro/</id>
        
        <content type="html" xml:base="https://blog.carrio.dev/blog/ddd-patterns-intro/">&lt;p&gt;What this post is, and what is isn&#x27;t.&lt;&#x2F;p&gt;
&lt;p&gt;This post is:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A brief intro to what &lt;a href=&quot;https:&#x2F;&#x2F;martinfowler.com&#x2F;bliki&#x2F;DomainDrivenDesign.html&quot;&gt;DDD&lt;&#x2F;a&gt; is.&lt;&#x2F;li&gt;
&lt;li&gt;Covering some tactical design patterns for DDD.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This post is not:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Covering strategic design patterns, e.g. &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Event_storming&quot;&gt;Event Storming&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;martinfowler.com&#x2F;bliki&#x2F;DomainDrivenDesign.html&quot;&gt;Domain-driven design (DDD)&lt;&#x2F;a&gt; is an approach I&#x27;ve taken on various projects historical and one that I&#x27;m still not sure I&#x27;ve entirely &lt;em&gt;mastered&lt;&#x2F;em&gt;. There is a lot of nuance to DDD, namely the matter of buy-in from stakeholders across the organization, truly working hand-in-hand with domain experts, assuming you have them- and if you don&#x27;t, then also building up that expertise in your team- and finally championing that mentality across all of the silos in your workplace. &lt;em&gt;Everyone&lt;&#x2F;em&gt; needs to be on board, and that&#x27;s just from a &lt;em&gt;strategic&lt;&#x2F;em&gt; design standpoint. Practicing domain-driven design is hard, much like software engineering can be in general, but it&#x27;s also a foreign concept to many developers out there.&lt;&#x2F;p&gt;
&lt;p&gt;The core of domain-driven design, in my own words:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Domain-driven design is about designing your software in the way the business domain is structured, from the terminology used by each context of your product to the naming of your programming constructs.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;By most DDD practicioners&#x27; standards: your domain experts should be able to understand what&#x27;s happening in your code without being a programmer. This relates only to the domain portion of your code, and in many architectural approachs to software such as [hexagonal architecture], you would have that complete separation of the core domain logic from any application or infrastructure logic. These often pair well DDD, and there are many examples of implementing tactical DDD patterns online.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;reading-resources&quot;&gt;Reading Resources&lt;&#x2F;h2&gt;
&lt;p&gt;The absolute classics are the original &lt;a href=&quot;https:&#x2F;&#x2F;www.amazon.com&#x2F;gp&#x2F;product&#x2F;0321125215&quot;&gt;Eric Evans blue book, Domain-Driven Design: Tackling Complexity in the Heart of Software&lt;&#x2F;a&gt;, and the &lt;a href=&quot;https:&#x2F;&#x2F;www.amazon.com&#x2F;gp&#x2F;product&#x2F;0321834577&quot;&gt;Vaughn Vernon red book Implementing Domain-Driven Design&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;identifying-the-structure-of-the-business-domain&quot;&gt;Identifying the structure of the business domain&lt;&#x2F;h2&gt;
&lt;p&gt;This is the part I mentioned this post would NOT be. I&#x27;ll only cover some terminology that will be useful within this post:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Domain&lt;&#x2F;strong&gt;: Outside of DDD, this is defined as &amp;quot;a specified sphere of activity or knowledge&amp;quot;, which captures the essence well. This encapsulates both &lt;em&gt;what&lt;&#x2F;em&gt; your product does, and &lt;em&gt;how&lt;&#x2F;em&gt; it does it.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Subdomain&lt;&#x2F;strong&gt;: Your domain often will be split up into various subdomains, especially if it is as a whole a very broad concept. There are several types of subdomains, including &lt;em&gt;core&lt;&#x2F;em&gt;, &lt;em&gt;supporting&lt;&#x2F;em&gt;, and &lt;em&gt;generic&lt;&#x2F;em&gt; subdomains. The &lt;em&gt;core&lt;&#x2F;em&gt; subdomain would be the primary focus of your product and the value it offers that makes it great. A &lt;em&gt;supporting&lt;&#x2F;em&gt; subdomain is important for the product to succeed, but not the primary focus. A &lt;em&gt;generic&lt;&#x2F;em&gt; subdomain contains nothing &lt;em&gt;special&lt;&#x2F;em&gt; to the organization, but is necessary for the solution to work (think IAM or ERP platforms).&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https:&#x2F;&#x2F;martinfowler.com&#x2F;bliki&#x2F;UbiquitousLanguage.html&quot;&gt;Ubiquitous Language&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt;: Specific to each bounded context, the language is agreed upon and standard for how to refer to each component in the system. Domain experts and software engineers can easily discuss features because the ubiquitous language is consistent from design to implementation. As you can imagine, this takes a lot of interaction between domain experts and the programmers building the software.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https:&#x2F;&#x2F;martinfowler.com&#x2F;bliki&#x2F;BoundedContext.html&quot;&gt;Bounded Context&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt;: This is a specific subset of the overall domain where ubiquitous language is consistent. Often times the best structure for bounded contexts is 1:1 with subdomains of your system, but like many things in SWE this is situational. Not only is this a specific context, but there is well defined boundary for the context. This separates the components of your system linguistically, so the same terminology such as &amp;quot;Account&amp;quot; may not mean the same thing between two contexts, such as &amp;quot;Checkings&amp;quot; context and &amp;quot;Savings&amp;quot; context for a &amp;quot;Banking&amp;quot; domain. &lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Context Map&lt;&#x2F;strong&gt;: These define what the boundaries of the various contexts are, how contexts will communicate, how mappings between entities and other constructs will be done between contexts (e.g. translating the ubiquoutous language), how to protect against unwanted changes in upstream contexts, or how to ensure stability for downstream contexts.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;That is a lot to gather without much &lt;em&gt;context&lt;&#x2F;em&gt;, and if you are interested in the strategic design elements you should read more on it from the &lt;a href=&quot;https:&#x2F;&#x2F;www.amazon.com&#x2F;gp&#x2F;product&#x2F;0321125215&quot;&gt;blue book&lt;&#x2F;a&gt; and&#x2F;or &lt;a href=&quot;https:&#x2F;&#x2F;www.amazon.com&#x2F;gp&#x2F;product&#x2F;0321834577&quot;&gt;red book&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;domain-objects&quot;&gt;Domain Objects&lt;&#x2F;h2&gt;
&lt;p&gt;Even in 2003, Evans&#x27; &lt;a href=&quot;https:&#x2F;&#x2F;martinfowler.com&#x2F;bliki&#x2F;EvansClassification.html&quot;&gt;classified&lt;&#x2F;a&gt; some of the still relevant types of domain objects you&#x27;ll find in domain-driven design. These classifications include:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Entities&lt;&#x2F;strong&gt;: A distinctly identifiable object.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Value Objects&lt;&#x2F;strong&gt;: An object that matters only as an combination of its properties. There is no identifier for a value object, only what it contains.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Services&lt;&#x2F;strong&gt;: Typically stateless, these can provide a standalone operation within the context your domain.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Types from other patterns such as enterprise architecture, layered architecture, design patterns and more have been mostly adopted into domain-driven design as well, and you&#x27;ll commonly see many of the following:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Aggregates&lt;&#x2F;strong&gt;: An entity that defines the transactional boundary of logical operations within a context. It controls the entities beneath it, exposes functionality to domain logic that can impact those entities, but does not allow access to those nested entities. When the aggregate is persisted, the operations of root aggregate entity and all of the related entities must all successfully complete or the transaction will be rolled back. In this way, aggregates are atomic.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Domain Events&lt;&#x2F;strong&gt;: Events that signify specific, important happenings within a bounded context. This is a common way to communicate across bounded contexts while also reducing coupling of services.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Repositories&lt;&#x2F;strong&gt;: An abstraction over a collection of domain entities. This typically follows a collection-like or persistence-based approach. The repository mediates between the domain and data-mapping layers of the system.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Factory&lt;&#x2F;strong&gt;: A creational design pattern, which in its simplest form is an object that creates other objects. There are more specific subsets of the Factory pattern that support polymorphic return types as well.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Depending on which DDD tactical design patterns you implement, you may also end up seeing terminology like CQRS. We&#x27;ll hold off on diving any deeper for now.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;applied-domain-patterns&quot;&gt;Applied Domain Patterns&lt;&#x2F;h3&gt;
&lt;p&gt;The following adapts some of the code from a Destiny bot project a friend of mine was working on. The code was originally in JavaScript at the time and I thought I would convert it to utilize more domain-driven design patterns instead.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;By my standards, this is still a work in progress, but it&#x27;s a start.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;pre data-lang=&quot;typescript&quot; style=&quot;background-color:#171c19;color:#87928a;&quot; class=&quot;language-typescript &quot;&gt;&lt;code class=&quot;language-typescript&quot; data-lang=&quot;typescript&quot;&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F;&#x2F; Domain layer: Value Objects, Entities, Aggregates
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export abstract class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;ValueObject&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;&amp;lt;T&amp;gt; {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{}
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;StringValueObject &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;ValueObject&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;&amp;lt;string&amp;gt; {}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;NumberValueObject &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;ValueObject&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;&amp;lt;number&amp;gt; {}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex = &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;5&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;6&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;7&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;9&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;c&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;d&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;e&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;f&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex2 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex3 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex4 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex8 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;Hex12 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;FOUR = &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;AB89 = &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;9&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;UuidV4 = `&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}-${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}-${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;FOUR&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Hex3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}-${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;AB89&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;HEX3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}-${&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;HEX12&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;`;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;Uuid &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;ValueObject&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;&amp;lt;UuidV4&amp;gt; {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private static readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX &lt;&#x2F;span&gt;&lt;span&gt;= &#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[0-9a-f]&lt;&#x2F;span&gt;&lt;span&gt;{8}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[0-9a-f]&lt;&#x2F;span&gt;&lt;span&gt;{4}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;-4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[0-9a-f]&lt;&#x2F;span&gt;&lt;span&gt;{3}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[89ab][0-9a-f]&lt;&#x2F;span&gt;&lt;span&gt;{3}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[0-9a-f]&lt;&#x2F;span&gt;&lt;span&gt;{12}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;i&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;UuidV4&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;super&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;();
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span&gt;(): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;void {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Uuid&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;test&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.value), &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Value was not a valid Version 4 UUID&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;Email &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;StringValueObject &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private static readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX &lt;&#x2F;span&gt;&lt;span&gt;= &#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;@]&lt;&#x2F;span&gt;&lt;span&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;@]&lt;&#x2F;span&gt;&lt;span&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;i&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Email&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;super&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;();
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span&gt;(): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;void {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Email&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;test&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.value), &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Value was not a valid email address&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;Username &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;StringValueObject &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private static readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX &lt;&#x2F;span&gt;&lt;span&gt;= &#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;@]&lt;&#x2F;span&gt;&lt;span&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;^&lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;@]&lt;&#x2F;span&gt;&lt;span&gt;+&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;i&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Username&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;super&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;();
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;validate&lt;&#x2F;span&gt;&lt;span&gt;(): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;void {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;Username&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;REGEX&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;test&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.value), &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Value was not a valid email address&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F; Entities &amp;amp; Aggregates
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export interface &lt;&#x2F;span&gt;&lt;span&gt;Entity {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;: Uuid;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;Entity &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;implements &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Entity &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Uuid&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{}
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export type &lt;&#x2F;span&gt;&lt;span&gt;Aggregate = Entity;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;Aggregate &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Entity &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;User &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;implements &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Aggregate &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Uuid,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;email&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Email,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;firstName&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;StringValueObject,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;lastName&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;StringValueObject,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;public readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Username,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;super&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F;&#x2F; Domain Repositories
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F; A collection-oriented repository:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;Repository&amp;lt;T &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span&gt;Entity&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;add&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;model&lt;&#x2F;span&gt;&lt;span&gt;: T): Promise&amp;lt;void&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;model&lt;&#x2F;span&gt;&lt;span&gt;: T): Promise&amp;lt;void&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;delete&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;model&lt;&#x2F;span&gt;&lt;span&gt;: T): Promise&amp;lt;void&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F; A collection-oriented repository:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;PersistenceRepository&amp;lt;T&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Repository&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;T&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;persist&lt;&#x2F;span&gt;&lt;span&gt;(): Promise&amp;lt;void&amp;gt;; 
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;UserRepository &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;extends &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;Repository&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;User&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;existsByUsername&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username&lt;&#x2F;span&gt;&lt;span&gt;: string): Promise&amp;lt;boolean&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&#x2F;&#x2F;&#x2F; Infrastructure layer: We implement our interfaces 
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;MongooseSchema&amp;lt;T&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;exists&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;criteria&lt;&#x2F;span&gt;&lt;span&gt;: Partial&amp;lt;T&amp;gt;): Command&amp;lt;boolean&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;updateOne&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;criteria&lt;&#x2F;span&gt;&lt;span&gt;: Partial&amp;lt;T&amp;gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;operation&lt;&#x2F;span&gt;&lt;span&gt;: MongooseOperation&amp;lt;T&amp;gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;callback&lt;&#x2F;span&gt;&lt;span&gt;: (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;?: Error) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;any
&lt;&#x2F;span&gt;&lt;span&gt;  ): Promise&amp;lt;void&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;MongooseOperation&amp;lt;T&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;$set&lt;&#x2F;span&gt;&lt;span&gt;: Partial&amp;lt;T&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;Command&amp;lt;T&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;exec&lt;&#x2F;span&gt;&lt;span&gt;(): Promise&amp;lt;T&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;UserSchema {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;: string,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;email&lt;&#x2F;span&gt;&lt;span&gt;: string,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;firstName&lt;&#x2F;span&gt;&lt;span&gt;: string,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;lastName&lt;&#x2F;span&gt;&lt;span&gt;: string,
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username&lt;&#x2F;span&gt;&lt;span&gt;: string,
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;PersistenceObject {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;save&lt;&#x2F;span&gt;&lt;span&gt;(): Promise&amp;lt;void&amp;gt;;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span&gt;PersistenceObjectFactory&amp;lt;T&amp;gt; = (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;model&lt;&#x2F;span&gt;&lt;span&gt;: T) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;PersistenceObject;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;export class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a07e3b;&quot;&gt;MongoUserRepository &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;implements &lt;&#x2F;span&gt;&lt;span style=&quot;color:#489963;&quot;&gt;UserRepository &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;constructor&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;schema&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;MongooseSchema&amp;lt;UserSchema&amp;gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;factory&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;PersistenceObjectFactory&amp;lt;User&amp;gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;private readonly &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;logger&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Logger,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{ }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;add&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;User&lt;&#x2F;span&gt;&lt;span&gt;): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Promise&amp;lt;void&amp;gt; {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;userModel &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;factory&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;await &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;userModel&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;save&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;();
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;User&lt;&#x2F;span&gt;&lt;span&gt;): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Promise&amp;lt;void&amp;gt; {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;updateModel &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      email: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;email&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      firstName: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;firstName&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      lastName: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;lastName&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      username: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    };
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;schema&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;updateOne&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      { id: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.id },
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;      { $set: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;updateModel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;},
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    )
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;delete&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;User&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;schema&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;deleteOne&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;({ id: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;user&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.id });
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;existsByUsername&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;): &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;Promise&amp;lt;boolean&amp;gt; {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;this&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;schema&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;exists&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;({ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;username &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#1c9aa0;&quot;&gt;exec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;() &lt;&#x2F;span&gt;&lt;span&gt;? &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;true &lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;false&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;  }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ecf4ee;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;!-- References --&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Contributing to Open Source: A Stab at Go</title>
        <published>2023-07-28T00:00:00+00:00</published>
        <updated>2023-07-28T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://blog.carrio.dev/blog/open-source-a-go-story/"/>
        <id>https://blog.carrio.dev/blog/open-source-a-go-story/</id>
        
        <content type="html" xml:base="https://blog.carrio.dev/blog/open-source-a-go-story/">&lt;p&gt;In 2018, I had been diving further into Go, a relatively new language at the time from Google. I was interested in taking it a step further and contributing to a well known and professional open source project based in Go from a reputable team that could provide me reviews and advice. As a system admin and software engineer, I was already familiar with the tool &lt;a href=&quot;https:&#x2F;&#x2F;www.packer.io&#x2F;&quot;&gt;Packer&lt;&#x2F;a&gt; from HashiCorp and had used it personally on several occasions. Based on this, I decided to start there.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;finding-work&quot;&gt;Finding work&lt;&#x2F;h2&gt;
&lt;p&gt;With open source code, and especially in a well maintained project, it is very straightforward to find feature requests and bugs that need help. So, I dug through their &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hashicorp&#x2F;packer&#x2F;issues&quot;&gt;Issue List on GitHub&lt;&#x2F;a&gt;. I found a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hashicorp&#x2F;packer&#x2F;issues&#x2F;6464&quot;&gt;feature request&lt;&#x2F;a&gt; I thought was interesting regarding the &lt;a href=&quot;https:&#x2F;&#x2F;www.openstack.org&#x2F;&quot;&gt;OpenStack&lt;&#x2F;a&gt; integration for Packer.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Add support to select most recent source image when name is provided&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;This was something that felt very approachable to me, for the following reasons:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;An enhancement of existing code&lt;&#x2F;li&gt;
&lt;li&gt;A feature that has been implemented for an existing integration&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;I wasn&#x27;t at the point of making large architectural decisions around these things with Go, so these provided me certain handrails to getting an initial change request proposal together.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;planning&quot;&gt;Planning&lt;&#x2F;h2&gt;
&lt;p&gt;I discussed with other members of the community on the issue to determine further requirements and design strategy. After digging through the existing code for OpenStack, I discovered multiple components around this integration. I&#x27;ll go through each of the parts I had deemed necessary to research to scope out the required changes.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;researching-the-openstack-api&quot;&gt;Researching the OpenStack API&lt;&#x2F;h3&gt;
&lt;p&gt;The OpenStack API was going to be the primary gateway to implementing this functionality- supposing they did not offer the adequate functionality to implement this it would be a non-starter. As such, I started there, in the &lt;a href=&quot;https:&#x2F;&#x2F;developer.openstack.org&#x2F;api-ref&quot;&gt;OpenStack API documentation&lt;&#x2F;a&gt;.
The component responsible for serving images in OpenStack is [glance], an image service where users can upload and also discover assets. The image services support discovering, registering, and retrieving virtual machine images and exposes a REST API for both querying metadata and retrieving images. The &lt;a href=&quot;https:&#x2F;&#x2F;developer.openstack.org&#x2F;api-ref&#x2F;image&#x2F;v2&#x2F;&quot;&gt;OpenStack image v2 documentation&lt;&#x2F;a&gt; covered the available endpoints, including a &lt;a href=&quot;https:&#x2F;&#x2F;docs.openstack.org&#x2F;api-ref&#x2F;image&#x2F;v2&#x2F;?expanded=list-images-detail#list-images&quot;&gt;List Images API&lt;&#x2F;a&gt;.
The image API allows for additional query parameters to be passed in to filter and sort results. The important query parameters I identified include &lt;code&gt;limit&lt;&#x2F;code&gt;, &lt;code&gt;sort_key&lt;&#x2F;code&gt;, and &lt;code&gt;sort_dir&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;With the following query, it would be possible to search by an image name and return at most one result, which would be the most recent image created with that name:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;url&quot; style=&quot;background-color:#171c19;color:#87928a;&quot; class=&quot;language-url &quot;&gt;&lt;code class=&quot;language-url&quot; data-lang=&quot;url&quot;&gt;&lt;span&gt;?sort_key=created_at&amp;amp;sort_dir=desc&amp;amp;limit=1
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;scoping-out-packer-changes&quot;&gt;Scoping out Packer changes&lt;&#x2F;h3&gt;
&lt;h4 id=&quot;api-calls&quot;&gt;API calls&lt;&#x2F;h4&gt;
&lt;p&gt;OpenStack support was already built in to Packer, so this was already a solved problem. In terms of scoping out what changes would be necessary here, I primarily wanted to determine whether there was an internal implementation to Packer for calling and handling responses from the OpenStack API or if they were utilizing some library for accomplishing this. I found the &lt;a href=&quot;http:&#x2F;&#x2F;gophercloud.io&#x2F;&quot;&gt;gophercloud&lt;&#x2F;a&gt; package was being used in Packer already, so how I would interact with the API would be through that library. It also meant that if there was not support for the V2 API, I would likely be contributing a change to gophercloud in order to pull that update into Packer to support the OpenStack changes.&lt;&#x2F;p&gt;
&lt;p&gt;My initial review of the gophercloud code led me to believe that the image v2 API was not supported, so I &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;gophercloud&#x2F;gophercloud&#x2F;issues&#x2F;1111&quot;&gt;opened an issue on their project&lt;&#x2F;a&gt;. In actuality it had implemented both the older compute API that allowed for listing images as well as the new glance service&#x27;s API, and &lt;code&gt;@jtopjian&lt;&#x2F;code&gt; was very helpful in pointing me to the correct code in the library for API v2. This library has a &lt;code&gt;ListOpts&lt;&#x2F;code&gt; struct which is passed to marshal the query string dynamically.&lt;&#x2F;p&gt;
&lt;p&gt;Within the Packer issue, I was also getting good feedback around the gophercloud library and its capabilities for the image V2 API. With all of that squared away, I was assured in utilizing the existing library for this new feature.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;packer-configuration&quot;&gt;Packer configuration&lt;&#x2F;h4&gt;
&lt;p&gt;Another required change to support this functionality would be in the configuration file schema and its handling in the Packer executable. The configuration file would need to provide support for a &lt;code&gt;source_image_filter&lt;&#x2F;code&gt; attribute that would allow dynamically generating the query, similar to the &lt;code&gt;source_ami_filter&lt;&#x2F;code&gt; implementation for AWS. The configuration file could be advanced and allow for a full &lt;code&gt;ListOpts&lt;&#x2F;code&gt; structure to be passed in or simplified with a &lt;code&gt;most_recent_image&lt;&#x2F;code&gt; boolean flag. I continued to vocalize my design ideas in the Packer issue, and while waiting on feedback I started off on the solution.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;implementation&quot;&gt;Implementation&lt;&#x2F;h3&gt;
&lt;p&gt;The start of my work was on the configuration file updates. This would then be passed into the new functionality. After updating the structure, I began work on the &lt;code&gt;image_query.go&lt;&#x2F;code&gt; file. This was my first time working with the Reflection API in Go, and most languages provide some mechanism around this and it all falls under the umbrella of metaprogramming. My first pass in the PR was pretty rudimentary, and not having an OpenStack environment limited my ability to run a live test of my changes. All I had to go on were docs.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;testing&quot;&gt;Testing&lt;&#x2F;h4&gt;
&lt;p&gt;Never forget to test your code. There are very few open source projects I have seen that do not have automated testing and test coverage &lt;em&gt;especially&lt;&#x2F;em&gt; those run by corporations. The software needs to work, and stay working. Refactoring should feel safe, and if a breaking change is included it should be detected without anyone manually running your code. With the advent of DevOps and automation came a bright new age for software engineering- and continuous integration in your project ensures that you detect code smells and bugs faster than ever.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;iteration&quot;&gt;Iteration&lt;&#x2F;h3&gt;
&lt;p&gt;I prefaced this post with an important note: I was not a Go expert. In fact, I&#x27;m still not- it&#x27;s a tool I&#x27;ve used in a few scenarios over the past 5 years but it&#x27;s never been my primary language in open source or professional work. So, unsurprisingly, I had feedback on my changes. This is a very good thing, because getting feedback on our work is one of the greatest ways we learn. We receive insight into design patterns, functionality we didn&#x27;t know existed, or new topics we hadn&#x27;t dove into before. We don&#x27;t know what we don&#x27;t know, and someone being there to tell you what those things are is absolutely invaluable.&lt;&#x2F;p&gt;
&lt;p&gt;I went through several iterations of the work over the next &lt;strong&gt;month&lt;&#x2F;strong&gt;. &lt;code&gt;@rickard-von-essen&lt;&#x2F;code&gt; was immensely helpful during this code review, and I received a lot of support from other team members at Packer throughout the entire process too. It was an absolute joy to work on, and I was very happy with the result. The code hooked into the &lt;code&gt;packer validate&lt;&#x2F;code&gt; functionality, worked smoothly with the Image V2 API, applied defensive tactics on inputs, was well tested, and provided clear documentation.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;the-final-work&quot;&gt;The final work&lt;&#x2F;h3&gt;
&lt;p&gt;For reference, the full PR changes can be found &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hashicorp&#x2F;packer&#x2F;pull&#x2F;6490&#x2F;files&quot;&gt;here&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;diff go&quot; style=&quot;background-color:#171c19;color:#87928a;&quot; class=&quot;language-diff go &quot;&gt;&lt;code class=&quot;language-diff go&quot; data-lang=&quot;diff go&quot;&gt;&lt;span&gt;commit 70cfafb75c09d5ea54dccffb699b3e487ea7320a
&lt;&#x2F;span&gt;&lt;span&gt;Merge: bb319fb1e e2fe5cd77
&lt;&#x2F;span&gt;&lt;span&gt;Author: Rickard von Essen &amp;lt;rickard.von.essen@gmail.com&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;Date:   Thu Aug 23 12:41:06 2018 +0200
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    Merge pull request #6490 from tcarrio&#x2F;most-recent-image-openstack
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    OpenStack source image search filter
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;builder&#x2F;openstack&#x2F;builder.go b&#x2F;builder&#x2F;openstack&#x2F;builder.go
&lt;&#x2F;span&gt;&lt;span&gt;index 2938d67c0..638dcc8ba 100644
&lt;&#x2F;span&gt;&lt;span&gt;--- a&#x2F;builder&#x2F;openstack&#x2F;builder.go
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;builder&#x2F;openstack&#x2F;builder.go
&lt;&#x2F;span&gt;&lt;span&gt;@@ -86,6 +86,12 @@ func (b *Builder) Run(ui packer.Ui, hook packer.Hook, cache packer.Cache) (packe
&lt;&#x2F;span&gt;&lt;span&gt; 			PrivateKeyFile:       b.config.RunConfig.Comm.SSHPrivateKey,
&lt;&#x2F;span&gt;&lt;span&gt; 			SSHAgentAuth:         b.config.RunConfig.Comm.SSHAgentAuth,
&lt;&#x2F;span&gt;&lt;span&gt; 		},
&lt;&#x2F;span&gt;&lt;span&gt;+		&amp;amp;StepSourceImageInfo{
&lt;&#x2F;span&gt;&lt;span&gt;+			SourceImage:      b.config.RunConfig.SourceImage,
&lt;&#x2F;span&gt;&lt;span&gt;+			SourceImageName:  b.config.RunConfig.SourceImageName,
&lt;&#x2F;span&gt;&lt;span&gt;+			SourceImageOpts:  b.config.RunConfig.sourceImageOpts,
&lt;&#x2F;span&gt;&lt;span&gt;+			SourceMostRecent: b.config.SourceImageFilters.MostRecent,
&lt;&#x2F;span&gt;&lt;span&gt;+		},
&lt;&#x2F;span&gt;&lt;span&gt; 		&amp;amp;StepCreateVolume{
&lt;&#x2F;span&gt;&lt;span&gt; 			UseBlockStorageVolume:  b.config.UseBlockStorageVolume,
&lt;&#x2F;span&gt;&lt;span&gt; 			SourceImage:            b.config.SourceImage,
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;builder&#x2F;openstack&#x2F;run_config.go b&#x2F;builder&#x2F;openstack&#x2F;run_config.go
&lt;&#x2F;span&gt;&lt;span&gt;index b98b65ea8..ccc87dffc 100644
&lt;&#x2F;span&gt;&lt;span&gt;--- a&#x2F;builder&#x2F;openstack&#x2F;run_config.go
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;builder&#x2F;openstack&#x2F;run_config.go
&lt;&#x2F;span&gt;&lt;span&gt;@@ -4,6 +4,7 @@ import (
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;errors&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;fmt&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;gophercloud&#x2F;gophercloud&#x2F;openstack&#x2F;imageservice&#x2F;v2&#x2F;images&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;common&#x2F;uuid&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;helper&#x2F;communicator&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;template&#x2F;interpolate&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;@@ -18,21 +19,22 @@ type RunConfig struct {
&lt;&#x2F;span&gt;&lt;span&gt; 	SSHInterface         string              `mapstructure:&amp;quot;ssh_interface&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt; 	SSHIPVersion         string              `mapstructure:&amp;quot;ssh_ip_version&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;-	SourceImage       string            `mapstructure:&amp;quot;source_image&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	SourceImageName   string            `mapstructure:&amp;quot;source_image_name&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	Flavor            string            `mapstructure:&amp;quot;flavor&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	AvailabilityZone  string            `mapstructure:&amp;quot;availability_zone&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	RackconnectWait   bool              `mapstructure:&amp;quot;rackconnect_wait&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	FloatingIPNetwork string            `mapstructure:&amp;quot;floating_ip_network&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	FloatingIP        string            `mapstructure:&amp;quot;floating_ip&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	ReuseIPs          bool              `mapstructure:&amp;quot;reuse_ips&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	SecurityGroups    []string          `mapstructure:&amp;quot;security_groups&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	Networks          []string          `mapstructure:&amp;quot;networks&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	Ports             []string          `mapstructure:&amp;quot;ports&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	UserData          string            `mapstructure:&amp;quot;user_data&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	UserDataFile      string            `mapstructure:&amp;quot;user_data_file&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	InstanceName      string            `mapstructure:&amp;quot;instance_name&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;-	InstanceMetadata  map[string]string `mapstructure:&amp;quot;instance_metadata&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImage        string            `mapstructure:&amp;quot;source_image&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImageName    string            `mapstructure:&amp;quot;source_image_name&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImageFilters ImageFilter       `mapstructure:&amp;quot;source_image_filter&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Flavor             string            `mapstructure:&amp;quot;flavor&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	AvailabilityZone   string            `mapstructure:&amp;quot;availability_zone&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	RackconnectWait    bool              `mapstructure:&amp;quot;rackconnect_wait&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	FloatingIPNetwork  string            `mapstructure:&amp;quot;floating_ip_network&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	FloatingIP         string            `mapstructure:&amp;quot;floating_ip&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	ReuseIPs           bool              `mapstructure:&amp;quot;reuse_ips&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	SecurityGroups     []string          `mapstructure:&amp;quot;security_groups&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Networks           []string          `mapstructure:&amp;quot;networks&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Ports              []string          `mapstructure:&amp;quot;ports&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	UserData           string            `mapstructure:&amp;quot;user_data&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	UserDataFile       string            `mapstructure:&amp;quot;user_data_file&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	InstanceName       string            `mapstructure:&amp;quot;instance_name&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	InstanceMetadata   map[string]string `mapstructure:&amp;quot;instance_metadata&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; 	ConfigDrive bool `mapstructure:&amp;quot;config_drive&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;@@ -47,6 +49,52 @@ type RunConfig struct {
&lt;&#x2F;span&gt;&lt;span&gt; 	&#x2F;&#x2F; Not really used, but here for BC
&lt;&#x2F;span&gt;&lt;span&gt; 	OpenstackProvider string `mapstructure:&amp;quot;openstack_provider&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt; 	UseFloatingIp     bool   `mapstructure:&amp;quot;use_floating_ip&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	sourceImageOpts images.ListOpts
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+type ImageFilter struct {
&lt;&#x2F;span&gt;&lt;span&gt;+	Filters    ImageFilterOptions `mapstructure:&amp;quot;filters&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	MostRecent bool               `mapstructure:&amp;quot;most_recent&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+type ImageFilterOptions struct {
&lt;&#x2F;span&gt;&lt;span&gt;+	Name       string   `mapstructure:&amp;quot;name&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Owner      string   `mapstructure:&amp;quot;owner&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Tags       []string `mapstructure:&amp;quot;tags&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+	Visibility string   `mapstructure:&amp;quot;visibility&amp;quot;`
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+func (f *ImageFilterOptions) Empty() bool {
&lt;&#x2F;span&gt;&lt;span&gt;+	return f.Name == &amp;quot;&amp;quot; &amp;amp;&amp;amp; f.Owner == &amp;quot;&amp;quot; &amp;amp;&amp;amp; len(f.Tags) == 0 &amp;amp;&amp;amp; f.Visibility == &amp;quot;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+func (f *ImageFilterOptions) Build() (*images.ListOpts, error) {
&lt;&#x2F;span&gt;&lt;span&gt;+	opts := images.ListOpts{}
&lt;&#x2F;span&gt;&lt;span&gt;+	&#x2F;&#x2F; Set defaults for status, member_status, and sort
&lt;&#x2F;span&gt;&lt;span&gt;+	opts.Status = images.ImageStatusActive
&lt;&#x2F;span&gt;&lt;span&gt;+	opts.MemberStatus = images.ImageMemberStatusAccepted
&lt;&#x2F;span&gt;&lt;span&gt;+	opts.Sort = &amp;quot;created_at:desc&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	var err error
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if f.Name != &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		opts.Name = f.Name
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+	if f.Owner != &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		opts.Owner = f.Owner
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+	if len(f.Tags) &amp;gt; 0 {
&lt;&#x2F;span&gt;&lt;span&gt;+		opts.Tags = f.Tags
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+	if f.Visibility != &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		v, err := getImageVisibility(f.Visibility)
&lt;&#x2F;span&gt;&lt;span&gt;+		if err == nil {
&lt;&#x2F;span&gt;&lt;span&gt;+			opts.Visibility = *v
&lt;&#x2F;span&gt;&lt;span&gt;+		}
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	return &amp;amp;opts, err
&lt;&#x2F;span&gt;&lt;span&gt; }
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; func (c *RunConfig) Prepare(ctx *interpolate.Context) []error {
&lt;&#x2F;span&gt;&lt;span&gt;@@ -75,8 +123,8 @@ func (c *RunConfig) Prepare(ctx *interpolate.Context) []error {
&lt;&#x2F;span&gt;&lt;span&gt; 		}
&lt;&#x2F;span&gt;&lt;span&gt; 	}
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;-	if c.SourceImage == &amp;quot;&amp;quot; &amp;amp;&amp;amp; c.SourceImageName == &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;-		errs = append(errs, errors.New(&amp;quot;Either a source_image or a source_image_name must be specified&amp;quot;))
&lt;&#x2F;span&gt;&lt;span&gt;+	if c.SourceImage == &amp;quot;&amp;quot; &amp;amp;&amp;amp; c.SourceImageName == &amp;quot;&amp;quot; &amp;amp;&amp;amp; c.SourceImageFilters.Filters.Empty() {
&lt;&#x2F;span&gt;&lt;span&gt;+		errs = append(errs, errors.New(&amp;quot;Either a source_image, a source_image_name, or source_image_filter must be specified&amp;quot;))
&lt;&#x2F;span&gt;&lt;span&gt; 	} else if len(c.SourceImage) &amp;gt; 0 &amp;amp;&amp;amp; len(c.SourceImageName) &amp;gt; 0 {
&lt;&#x2F;span&gt;&lt;span&gt; 		errs = append(errs, errors.New(&amp;quot;Only a source_image or a source_image_name can be specified, not both.&amp;quot;))
&lt;&#x2F;span&gt;&lt;span&gt; 	}
&lt;&#x2F;span&gt;&lt;span&gt;@@ -111,5 +159,34 @@ func (c *RunConfig) Prepare(ctx *interpolate.Context) []error {
&lt;&#x2F;span&gt;&lt;span&gt; 		}
&lt;&#x2F;span&gt;&lt;span&gt; 	}
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;+	&#x2F;&#x2F; if neither ID or image name is provided outside the filter, build the filter
&lt;&#x2F;span&gt;&lt;span&gt;+	if len(c.SourceImage) == 0 &amp;amp;&amp;amp; len(c.SourceImageName) == 0 {
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+		listOpts, filterErr := c.SourceImageFilters.Filters.Build()
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+		if filterErr != nil {
&lt;&#x2F;span&gt;&lt;span&gt;+			errs = append(errs, filterErr)
&lt;&#x2F;span&gt;&lt;span&gt;+		}
&lt;&#x2F;span&gt;&lt;span&gt;+		c.sourceImageOpts = *listOpts
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt; 	return errs
&lt;&#x2F;span&gt;&lt;span&gt; }
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+&#x2F;&#x2F; Retrieve the specific ImageVisibility using the exported const from images
&lt;&#x2F;span&gt;&lt;span&gt;+func getImageVisibility(visibility string) (*images.ImageVisibility, error) {
&lt;&#x2F;span&gt;&lt;span&gt;+	visibilities := [...]images.ImageVisibility{
&lt;&#x2F;span&gt;&lt;span&gt;+		images.ImageVisibilityPublic,
&lt;&#x2F;span&gt;&lt;span&gt;+		images.ImageVisibilityPrivate,
&lt;&#x2F;span&gt;&lt;span&gt;+		images.ImageVisibilityCommunity,
&lt;&#x2F;span&gt;&lt;span&gt;+		images.ImageVisibilityShared,
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	for _, v := range visibilities {
&lt;&#x2F;span&gt;&lt;span&gt;+		if string(v) == visibility {
&lt;&#x2F;span&gt;&lt;span&gt;+			return &amp;amp;v, nil
&lt;&#x2F;span&gt;&lt;span&gt;+		}
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	return nil, fmt.Errorf(&amp;quot;Not a valid visibility: %s&amp;quot;, visibility)
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;builder&#x2F;openstack&#x2F;run_config_test.go b&#x2F;builder&#x2F;openstack&#x2F;run_config_test.go
&lt;&#x2F;span&gt;&lt;span&gt;index 6ce0cf602..f660a4e82 100644
&lt;&#x2F;span&gt;&lt;span&gt;--- a&#x2F;builder&#x2F;openstack&#x2F;run_config_test.go
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;builder&#x2F;openstack&#x2F;run_config_test.go
&lt;&#x2F;span&gt;&lt;span&gt;@@ -4,7 +4,9 @@ import (
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;os&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;testing&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;gophercloud&#x2F;gophercloud&#x2F;openstack&#x2F;imageservice&#x2F;v2&#x2F;images&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; 	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;helper&#x2F;communicator&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;mitchellh&#x2F;mapstructure&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt; )
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; func init() {
&lt;&#x2F;span&gt;&lt;span&gt;@@ -127,3 +129,84 @@ func TestRunConfigPrepare_FloatingIPPoolCompat(t *testing.T) {
&lt;&#x2F;span&gt;&lt;span&gt; 		t.Fatalf(&amp;quot;invalid value: %s&amp;quot;, c.FloatingIPNetwork)
&lt;&#x2F;span&gt;&lt;span&gt; 	}
&lt;&#x2F;span&gt;&lt;span&gt; }
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+&#x2F;&#x2F; This test case confirms that only allowed fields will be set to values
&lt;&#x2F;span&gt;&lt;span&gt;+&#x2F;&#x2F; The checked values are non-nil for their target type
&lt;&#x2F;span&gt;&lt;span&gt;+func TestBuildImageFilter(t *testing.T) {
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	filters := ImageFilterOptions{
&lt;&#x2F;span&gt;&lt;span&gt;+		Name:       &amp;quot;Ubuntu 16.04&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Visibility: &amp;quot;public&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Owner:      &amp;quot;1234567890&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Tags:       []string{&amp;quot;prod&amp;quot;, &amp;quot;ready&amp;quot;},
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	listOpts, err := filters.Build()
&lt;&#x2F;span&gt;&lt;span&gt;+	if err != nil {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Building filter failed with: %s&amp;quot;, err)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.Name != &amp;quot;Ubuntu 16.04&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Name did not build correctly: %s&amp;quot;, listOpts.Name)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.Visibility != images.ImageVisibilityPublic {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Visibility did not build correctly: %s&amp;quot;, listOpts.Visibility)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.Owner != &amp;quot;1234567890&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Owner did not build correctly: %s&amp;quot;, listOpts.Owner)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+func TestBuildBadImageFilter(t *testing.T) {
&lt;&#x2F;span&gt;&lt;span&gt;+	filterMap := map[string]interface{}{
&lt;&#x2F;span&gt;&lt;span&gt;+		&amp;quot;limit&amp;quot;:    &amp;quot;3&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		&amp;quot;size_min&amp;quot;: &amp;quot;25&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	filters := ImageFilterOptions{}
&lt;&#x2F;span&gt;&lt;span&gt;+	mapstructure.Decode(filterMap, &amp;amp;filters)
&lt;&#x2F;span&gt;&lt;span&gt;+	listOpts, err := filters.Build()
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if err != nil {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Error returned processing image filter: %s&amp;quot;, err.Error())
&lt;&#x2F;span&gt;&lt;span&gt;+		return &#x2F;&#x2F; we cannot trust listOpts to not cause unexpected behaviour
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.Limit == filterMap[&amp;quot;limit&amp;quot;] {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Limit was parsed into ListOpts: %d&amp;quot;, listOpts.Limit)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.SizeMin != 0 {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;SizeMin was parsed into ListOpts: %d&amp;quot;, listOpts.SizeMin)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if listOpts.Sort != &amp;quot;created_at:desc&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Sort was not applied: %s&amp;quot;, listOpts.Sort)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if !filters.Empty() {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;The filters should be empty due to lack of input&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+&#x2F;&#x2F; Tests that the Empty method on ImageFilterOptions works as expected
&lt;&#x2F;span&gt;&lt;span&gt;+func TestImageFiltersEmpty(t *testing.T) {
&lt;&#x2F;span&gt;&lt;span&gt;+	filledFilters := ImageFilterOptions{
&lt;&#x2F;span&gt;&lt;span&gt;+		Name:       &amp;quot;Ubuntu 16.04&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Visibility: &amp;quot;public&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Owner:      &amp;quot;1234567890&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+		Tags:       []string{&amp;quot;prod&amp;quot;, &amp;quot;ready&amp;quot;},
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if filledFilters.Empty() {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Expected filled filters to be non-empty: %v&amp;quot;, filledFilters)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	emptyFilters := ImageFilterOptions{}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if !emptyFilters.Empty() {
&lt;&#x2F;span&gt;&lt;span&gt;+		t.Errorf(&amp;quot;Expected default filter to be empty: %v&amp;quot;, emptyFilters)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;builder&#x2F;openstack&#x2F;step_run_source_server.go b&#x2F;builder&#x2F;openstack&#x2F;step_run_source_server.go
&lt;&#x2F;span&gt;&lt;span&gt;index e56218467..6bbb40eba 100644
&lt;&#x2F;span&gt;&lt;span&gt;--- a&#x2F;builder&#x2F;openstack&#x2F;step_run_source_server.go
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;builder&#x2F;openstack&#x2F;step_run_source_server.go
&lt;&#x2F;span&gt;&lt;span&gt;@@ -76,6 +76,12 @@ func (s *StepRunSourceServer) Run(_ context.Context, state multistep.StateBag) m
&lt;&#x2F;span&gt;&lt;span&gt; 		ServiceClient:    computeClient,
&lt;&#x2F;span&gt;&lt;span&gt; 		Metadata:         s.InstanceMetadata,
&lt;&#x2F;span&gt;&lt;span&gt; 	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	&#x2F;&#x2F; check if image filter returned a source image ID and replace
&lt;&#x2F;span&gt;&lt;span&gt;+	if imageID, ok := state.GetOk(&amp;quot;source_image&amp;quot;); ok {
&lt;&#x2F;span&gt;&lt;span&gt;+		serverOpts.ImageRef = imageID.(string)
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt; 	var serverOptsExt servers.CreateOptsBuilder
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; 	&#x2F;&#x2F; Create root volume in the Block Storage service if required.
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;builder&#x2F;openstack&#x2F;step_source_image_info.go b&#x2F;builder&#x2F;openstack&#x2F;step_source_image_info.go
&lt;&#x2F;span&gt;&lt;span&gt;new file mode 100644
&lt;&#x2F;span&gt;&lt;span&gt;index 000000000..6cf3500ae
&lt;&#x2F;span&gt;&lt;span&gt;--- &#x2F;dev&#x2F;null
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;builder&#x2F;openstack&#x2F;step_source_image_info.go
&lt;&#x2F;span&gt;&lt;span&gt;@@ -0,0 +1,76 @@
&lt;&#x2F;span&gt;&lt;span&gt;+package openstack
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+import (
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;context&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;fmt&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;log&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;gophercloud&#x2F;gophercloud&#x2F;openstack&#x2F;imageservice&#x2F;v2&#x2F;images&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;gophercloud&#x2F;gophercloud&#x2F;pagination&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;helper&#x2F;multistep&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+	&amp;quot;github.com&#x2F;hashicorp&#x2F;packer&#x2F;packer&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;+)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+type StepSourceImageInfo struct {
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImage      string
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImageName  string
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceImageOpts  images.ListOpts
&lt;&#x2F;span&gt;&lt;span&gt;+	SourceMostRecent bool
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+func (s *StepSourceImageInfo) Run(_ context.Context, state multistep.StateBag) multistep.StepAction {
&lt;&#x2F;span&gt;&lt;span&gt;+	config := state.Get(&amp;quot;config&amp;quot;).(Config)
&lt;&#x2F;span&gt;&lt;span&gt;+	ui := state.Get(&amp;quot;ui&amp;quot;).(packer.Ui)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if s.SourceImage != &amp;quot;&amp;quot; || s.SourceImageName != &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		return multistep.ActionContinue
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	client, err := config.imageV2Client()
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	log.Printf(&amp;quot;Using Image Filters %v&amp;quot;, s.SourceImageOpts)
&lt;&#x2F;span&gt;&lt;span&gt;+	image := &amp;amp;images.Image{}
&lt;&#x2F;span&gt;&lt;span&gt;+	err = images.List(client, s.SourceImageOpts).EachPage(func(page pagination.Page) (bool, error) {
&lt;&#x2F;span&gt;&lt;span&gt;+		i, err := images.ExtractImages(page)
&lt;&#x2F;span&gt;&lt;span&gt;+		if err != nil {
&lt;&#x2F;span&gt;&lt;span&gt;+			return false, err
&lt;&#x2F;span&gt;&lt;span&gt;+		}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+		switch len(i) {
&lt;&#x2F;span&gt;&lt;span&gt;+		case 1:
&lt;&#x2F;span&gt;&lt;span&gt;+			*image = i[0]
&lt;&#x2F;span&gt;&lt;span&gt;+			return false, nil
&lt;&#x2F;span&gt;&lt;span&gt;+		default:
&lt;&#x2F;span&gt;&lt;span&gt;+			if s.SourceMostRecent {
&lt;&#x2F;span&gt;&lt;span&gt;+				*image = i[0]
&lt;&#x2F;span&gt;&lt;span&gt;+				return false, nil
&lt;&#x2F;span&gt;&lt;span&gt;+			}
&lt;&#x2F;span&gt;&lt;span&gt;+			return false, fmt.Errorf(
&lt;&#x2F;span&gt;&lt;span&gt;+				&amp;quot;Your query returned more than one result. Please try a more specific search, or set most_recent to true. Search filters: %v&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+				s.SourceImageOpts)
&lt;&#x2F;span&gt;&lt;span&gt;+		}
&lt;&#x2F;span&gt;&lt;span&gt;+	})
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if err != nil {
&lt;&#x2F;span&gt;&lt;span&gt;+		err := fmt.Errorf(&amp;quot;Error querying image: %s&amp;quot;, err)
&lt;&#x2F;span&gt;&lt;span&gt;+		state.Put(&amp;quot;error&amp;quot;, err)
&lt;&#x2F;span&gt;&lt;span&gt;+		ui.Error(err.Error())
&lt;&#x2F;span&gt;&lt;span&gt;+		return multistep.ActionHalt
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	if image.ID == &amp;quot;&amp;quot; {
&lt;&#x2F;span&gt;&lt;span&gt;+		err := fmt.Errorf(&amp;quot;No image was found matching filters: %v&amp;quot;, s.SourceImageOpts)
&lt;&#x2F;span&gt;&lt;span&gt;+		state.Put(&amp;quot;error&amp;quot;, err)
&lt;&#x2F;span&gt;&lt;span&gt;+		ui.Error(err.Error())
&lt;&#x2F;span&gt;&lt;span&gt;+		return multistep.ActionHalt
&lt;&#x2F;span&gt;&lt;span&gt;+	}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	ui.Message(fmt.Sprintf(&amp;quot;Found Image ID: %s&amp;quot;, image.ID))
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+	state.Put(&amp;quot;source_image&amp;quot;, image.ID)
&lt;&#x2F;span&gt;&lt;span&gt;+	return multistep.ActionContinue
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+func (s *StepSourceImageInfo) Cleanup(state multistep.StateBag) {
&lt;&#x2F;span&gt;&lt;span&gt;+	&#x2F;&#x2F; No cleanup required for backout
&lt;&#x2F;span&gt;&lt;span&gt;+}
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;website&#x2F;source&#x2F;docs&#x2F;builders&#x2F;openstack.html.md b&#x2F;website&#x2F;source&#x2F;docs&#x2F;builders&#x2F;openstack.html.md
&lt;&#x2F;span&gt;&lt;span&gt;index a05ce3d67..28566bd0d 100644
&lt;&#x2F;span&gt;&lt;span&gt;--- a&#x2F;website&#x2F;source&#x2F;docs&#x2F;builders&#x2F;openstack.html.md
&lt;&#x2F;span&gt;&lt;span&gt;+++ b&#x2F;website&#x2F;source&#x2F;docs&#x2F;builders&#x2F;openstack.html.md
&lt;&#x2F;span&gt;&lt;span&gt;@@ -70,6 +70,11 @@ builder.
&lt;&#x2F;span&gt;&lt;span&gt;     is an alternative way of providing `source_image` and only either of them
&lt;&#x2F;span&gt;&lt;span&gt;     can be specified.
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;+-   `source_image_filter` (map) - The search filters for determining the base
&lt;&#x2F;span&gt;&lt;span&gt;+    image to use. This is an alternative way of providing `source_image` and
&lt;&#x2F;span&gt;&lt;span&gt;+    only one of these methods can be used. `source_image` will override the
&lt;&#x2F;span&gt;&lt;span&gt;+    filters.
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt; -   `username` or `user_id` (string) - The username or id used to connect to
&lt;&#x2F;span&gt;&lt;span&gt;     the OpenStack service. If not specified, Packer will use the environment
&lt;&#x2F;span&gt;&lt;span&gt;     variable `OS_USERNAME` or `OS_USERID`, if set. This is not required if
&lt;&#x2F;span&gt;&lt;span&gt;@@ -153,7 +158,7 @@ builder.
&lt;&#x2F;span&gt;&lt;span&gt;     Defaults to false.
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; -   `region` (string) - The name of the region, such as &amp;quot;DFW&amp;quot;, in which to
&lt;&#x2F;span&gt;&lt;span&gt;-    launch the server to create the AMI. If not specified, Packer will use the
&lt;&#x2F;span&gt;&lt;span&gt;+    launch the server to create the image. If not specified, Packer will use the
&lt;&#x2F;span&gt;&lt;span&gt;     environment variable `OS_REGION_NAME`, if set.
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt; -   `reuse_ips` (boolean) - Whether or not to attempt to reuse existing
&lt;&#x2F;span&gt;&lt;span&gt;@@ -166,6 +171,48 @@ builder.
&lt;&#x2F;span&gt;&lt;span&gt; -   `security_groups` (array of strings) - A list of security groups by name to
&lt;&#x2F;span&gt;&lt;span&gt;     add to this instance.
&lt;&#x2F;span&gt;&lt;span&gt; 
&lt;&#x2F;span&gt;&lt;span&gt;+-   `source_image_filter` (object) - Filters used to populate filter options.
&lt;&#x2F;span&gt;&lt;span&gt;+    Example:
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+    ``` json
&lt;&#x2F;span&gt;&lt;span&gt;+    {
&lt;&#x2F;span&gt;&lt;span&gt;+        &amp;quot;source_image_filter&amp;quot;: {
&lt;&#x2F;span&gt;&lt;span&gt;+            &amp;quot;filters&amp;quot;: {
&lt;&#x2F;span&gt;&lt;span&gt;+                &amp;quot;name&amp;quot;: &amp;quot;ubuntu-16.04&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+                &amp;quot;visibility&amp;quot;: &amp;quot;protected&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+                &amp;quot;owner&amp;quot;: &amp;quot;d1a588cf4b0743344508dc145649372d1&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;+                &amp;quot;tags&amp;quot;: [&amp;quot;prod&amp;quot;, &amp;quot;ready&amp;quot;]
&lt;&#x2F;span&gt;&lt;span&gt;+            },
&lt;&#x2F;span&gt;&lt;span&gt;+            &amp;quot;most_recent&amp;quot;: true
&lt;&#x2F;span&gt;&lt;span&gt;+        }
&lt;&#x2F;span&gt;&lt;span&gt;+    }
&lt;&#x2F;span&gt;&lt;span&gt;+    ```
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+    This selects the most recent production Ubuntu 16.04 shared to you by the given owner.
&lt;&#x2F;span&gt;&lt;span&gt;+    NOTE: This will fail unless *exactly* one image is returned, or `most_recent` is set to true.
&lt;&#x2F;span&gt;&lt;span&gt;+    In the example of multiple returned images, `most_recent` will cause this to succeed by selecting
&lt;&#x2F;span&gt;&lt;span&gt;+    the newest image of the returned images.
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+    -   `filters` (map of strings) - filters used to select a `source_image`.
&lt;&#x2F;span&gt;&lt;span&gt;+        NOTE: This will fail unless *exactly* one image is returned, or `most_recent` is set to true.
&lt;&#x2F;span&gt;&lt;span&gt;+        Of the filters described in [ImageService](https:&#x2F;&#x2F;developer.openstack.org&#x2F;api-ref&#x2F;image&#x2F;v2&#x2F;), the following
&lt;&#x2F;span&gt;&lt;span&gt;+        are valid:
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+        - name (string)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+        - owner (string)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+        - tags (array of strings)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+        - visibility (string)
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+    -   `most_recent` (boolean) - Selects the newest created image when true.
&lt;&#x2F;span&gt;&lt;span&gt;+        This is most useful for selecting a daily distro build.
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt;+    You may set use this in place of `source_image` If `source_image_filter` is provided
&lt;&#x2F;span&gt;&lt;span&gt;+    alongside `source_image`, the `source_image` will override the filter. The filter
&lt;&#x2F;span&gt;&lt;span&gt;+    will not be used in this case.
&lt;&#x2F;span&gt;&lt;span&gt;+
&lt;&#x2F;span&gt;&lt;span&gt; -   `ssh_interface` (string) - The type of interface to connect via SSH. Values
&lt;&#x2F;span&gt;&lt;span&gt;     useful for Rackspace are &amp;quot;public&amp;quot; or &amp;quot;private&amp;quot;, and the default behavior is
&lt;&#x2F;span&gt;&lt;span&gt;     to connect via whichever is returned first from the OpenStack API.
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;!-- References --&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Codility :: Sparse Integer Decomposition</title>
        <published>2023-07-21T00:00:00+00:00</published>
        <updated>2023-07-21T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://blog.carrio.dev/blog/sparse-integer-decomposition/"/>
        <id>https://blog.carrio.dev/blog/sparse-integer-decomposition/</id>
        
        <content type="html" xml:base="https://blog.carrio.dev/blog/sparse-integer-decomposition/">&lt;p&gt;Awhile back I had worked on some Codility exercises, one of which was this case for sparse integer decomposition. This solution ended up snagging me a top 5 percentile in performance and I figured I would share the approach.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-task&quot;&gt;The Task&lt;&#x2F;h2&gt;
&lt;p&gt;A non-negative integer N is called sparse if its binary representation does not contain two consecutive bits set to 1. For example, 41 is sparse, because its binary representation is &amp;quot;101001&amp;quot; and it does not contain two consecutive 1s. On the other hand, 26 is not sparse, because its binary representation is &amp;quot;11010&amp;quot; and it contains two consecutive 1s.&lt;&#x2F;p&gt;
&lt;p&gt;Two non-negative integers P and Q are called a sparse decomposition of integer N if P and Q are sparse and N = P + Q.&lt;&#x2F;p&gt;
&lt;p&gt;For example:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#171c19;color:#87928a;&quot;&gt;&lt;code&gt;&lt;span&gt;    8 and 18 are a sparse decomposition of 26 (binary representation of 8 is &amp;quot;1000&amp;quot;, binary representation of 18 is &amp;quot;10010&amp;quot;);
&lt;&#x2F;span&gt;&lt;span&gt;    9 and 17 are a sparse decomposition of 26 (binary representation of 9 is &amp;quot;1001&amp;quot;, binary representation of 17 is &amp;quot;10001&amp;quot;);
&lt;&#x2F;span&gt;&lt;span&gt;    2 and 24 are not a sparse decomposition of 26; though 2 + 24 = 26, the binary representation of 24 is &amp;quot;11000&amp;quot;, which is not sparse.
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Write a function:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#171c19;color:#87928a;&quot;&gt;&lt;code&gt;&lt;span&gt;def solution(N)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;that, given a non-negative integer N, returns any integer that is one part of a sparse decomposition of N. The function should return −1 if there is no sparse decomposition of N.&lt;&#x2F;p&gt;
&lt;p&gt;For example, given N = 26 the function may return 8, 9, 17 or 18, as explained in the example above. All other possible results for N = 26 are 5, 10, 16 and 21.&lt;&#x2F;p&gt;
&lt;p&gt;Write an efficient algorithm for the following assumptions:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#171c19;color:#87928a;&quot;&gt;&lt;code&gt;&lt;span&gt;    N is an integer within the range [0..1,000,000,000].
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;python&quot; style=&quot;background-color:#171c19;color:#87928a;&quot; class=&quot;language-python &quot;&gt;&lt;code class=&quot;language-python&quot; data-lang=&quot;python&quot;&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;from &lt;&#x2F;span&gt;&lt;span&gt;math &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span&gt;ceil, log2
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;calculate_alternating_mask&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;value&lt;&#x2F;span&gt;&lt;span&gt;):
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&amp;quot;&amp;quot;&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    calculate_alternating_mask determines a binary mask with a maximum
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    range based on the provided value, then iterates through each bit in
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    the mask, alternating the setting of that bit to 0.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    the end result is a mask with at most every other bit set to 1, in the
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    worst case scenario that all bits were 1 in the binary representation
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    of the input value.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(15) -&amp;gt; 0b1010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(0b1111) -&amp;gt; 0b1010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(0xf) -&amp;gt; 0b1010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(255) -&amp;gt; 0b10101010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(0b11111111) -&amp;gt; 0b10101010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    @example: calculate_alternating_mask(0xff) -&amp;gt; 0b10101010
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    binary_index = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;ceil&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;log2&lt;&#x2F;span&gt;&lt;span&gt;(value))
&lt;&#x2F;span&gt;&lt;span&gt;    alternating_mask = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;2 &lt;&#x2F;span&gt;&lt;span&gt;** binary_index - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    zero_bit = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;while &lt;&#x2F;span&gt;&lt;span&gt;binary_index &amp;gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(zero_bit == &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;):
&lt;&#x2F;span&gt;&lt;span&gt;            alternating_mask -= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;2 &lt;&#x2F;span&gt;&lt;span&gt;** binary_index
&lt;&#x2F;span&gt;&lt;span&gt;        
&lt;&#x2F;span&gt;&lt;span&gt;        zero_bit ^= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;0b1
&lt;&#x2F;span&gt;&lt;span&gt;        binary_index -= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;alternating_mask
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#478c90;&quot;&gt;solution&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;N&lt;&#x2F;span&gt;&lt;span&gt;):
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;&amp;quot;&amp;quot;&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    solution will specially handle cases at the minimum range of valid
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    input values to return early. otherwise, an alternating mask will
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    be generated to calculate a sparse integer based on the value.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5f6d64;&quot;&gt;    &amp;quot;&amp;quot;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;N &amp;lt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#9f713c;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;N
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#55859b;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;N &amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b16139;&quot;&gt;calculate_alternating_mask&lt;&#x2F;span&gt;&lt;span&gt;(N)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;the-breakdown&quot;&gt;The Breakdown&lt;&#x2F;h2&gt;
&lt;p&gt;The wording of the problem would seem to indicate that it&#x27;s possible to not find a sparse decomposition of a value, but generally speaking there will always be two components to derive from a single non-negative integer. The restrictions are only that the integer be part a sparse decomposition that has a corresponding but not reported sparse decomposition integer whose sums are the original value N. Since these decompositions are not limited by N &amp;gt; 0 or N &amp;gt; 1, this means we can break down any value M into N + P where 0 ≤ N ≤ M.&lt;&#x2F;p&gt;
&lt;p&gt;With all of that in mind, the methodology here is to generate an alternating bitmask (1010101...) of equivalent binary order to the input number (4 = 0b100, mask = 0b101. 15 = 0b1111, mask = 0b1010). That is binary &lt;code&gt;AND&lt;&#x2F;code&gt;ed with the input number M to calculate a decomposition where there is never two successive 1s, as it&#x27;s mathematically impossible given the mask never has two successive 1s and the nature of the binary AND operation.&lt;&#x2F;p&gt;
&lt;p&gt;This only works because of loose requirements. For example, if the requirements were instead 0 &amp;lt; N &amp;lt; M, we could not return 0 or M. This solution could be extended to cover scenarios where the initial bitmask (1010) AND returns 0 or M, where we could bitshift the mask (0101) and repeat the check. At this point, if the result still returns 0 or M, there is no sparse decomposition that fulfills 0 &amp;lt; N &amp;lt; M.&lt;&#x2F;p&gt;
</content>
        
    </entry>
</feed>
